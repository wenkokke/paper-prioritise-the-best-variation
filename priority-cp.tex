% !TeX root = priorities.tex
\documentclass[main.tex]{subfiles}

\begin{document}

\section{Relation to Priority CP}\label{sec:pcp}

This section presents an updated version of Priority CP~\cite[PCP]{dardhagay18}, which is Wadler's Classical Processes~\cite[CP]{wadler12} with \emph{priorities}, and a translation from PCP to PGV.

The main difference with respect to PCP by Dardha and Gay~\cite{dardhagay18} is the removal of commuting conversions, in favour of using the structural congruence. Commuting conversions are necessary if we want our reduction strategy to correspond \emph{exactly} to standard cut elimination. However, as Lindley and Morris~\cite{lindleymorris15} show, all $\beta$-reductions that can be performed \emph{with} the use of commuting conversions, can also be performed \emph{without} them. They show this by decomposing the reduction relation for CP into two phases: first, all $\beta$-reductions are performed, and second, commuting conversions are used to bring one particular action to the front, to eliminate the top-level cut.

From the perspective of process calculus, commuting conversions behave strangely. Let us consider the commuting conversion for $\pcp{\tm{\recv{x}{y}{P}}}$:
\[
  \usingnamespace{pcp}
  (\kappa_{\parr})
  \quad
  \tm{\res{z}{z'}{(\ppar{\recv{x}{y}{P}}{Q})}}
  \red
  \tm{\recv{x}{y}{\res{z}{z'}{(\ppar{P}{Q})}}}
\]
As a result of $(\kappa_{\parr})$, $\pcp{\tm{Q}}$ becomes blocked on $\pcp{\tm{\labrecv{x}{y}}}$, and any actions $\pcp{\tm{Q}}$ was able to perform become unavailable. Consequently, CP is non-confluent. For instance,
\begin{mathpar}
  \usingnamespace{pcp}
  \setlength{\arraycolsep}{2em}
  \begin{array}{cc}
    \multicolumn{2}{c}{%
    \hspace*{10ex}
    {\tm{\res{x}{x'}{(\ppar{\recv{a}{y}{P}}{\res{z}{z'}{(\ppar{\close{z}{\halt}}{\wait{z'}{Q}})}})}}}}
    \\
    \qquad\rotatebox[origin=c]{215}{$\red$}
    &
    \rotatebox[origin=c]{325}{$\red^+$}\qquad
    \\
    {\tm{\recv{a}{y}{\res{x}{x'}{(\ppar{P}{\res{z}{z'}{(\ppar{\close{z}{\halt}}{\wait{z'}{Q}})}})}}}}
    &
    {\tm{\recv{a}{y}{\res{x}{x'}{(\ppar{P}{Q})}}}}
  \end{array}
\end{mathpar}
Commuting conversions break our intuition that an action with lower priority occurs before an action with higher priority, since ``if a prefix on a channel endpoint $\pcp{\tm{x}}$ with priority $\cs{o}$ is pulled out at top level, then to preserve priority conditions in the typing rules [..], it is necessary to increase priorities of all actions after the prefix on $\pcp{\tm{x}}$'' by $\cs{o+1}$~\cite{dardhagay18}.

\subsubsection*{Example}\label{sec:pcp-example}
We introduce PCP by revising Milner's cyclic scheduler~\cite{milner89,dardhagay18}. Our PCP scheduler has exactly the same behaviour as the version presented in~\cref{sec:pgv-example}. We use $\pcp{\tm{\prod_{i}P_i}}$ to denote the parallel composition of the processes $\pcp{\tm{P_i}}$, and $\pcp{\plug{P}{Q}}$ to denote the plugging of $\pcp{\tm{Q}}$ in the one-hole process context $\pcp{\tm{P}}$:
\[
  \usingnamespace{pcp}
  \begin{array}{lrlr}
    \tm{\sched}
    & \defeq & \tm{\res{a_1}{a'_1}{\dots{\res{a_n}{a'_n}{}}}}
               \tm{\res{b_1}{b'_1}{\dots{\res{b_n}{b'_n}{}}}}
               \tm{\res{c_1}{c'_1}{\dots{\res{c_n}{c'_n}{}}}}
               \tm{\res{d}{d'}{}}
    \\ &     & \tm{(
               \ppar{\proc1}{\agent1}
               \parallel
               \prod_{2\leq{i}\leq{n}}(\ppar{\proc{i}}{\wait{c'_{i-1}}{\agent{i}}})
               )}
    \\
    \tm{\agent1}
    & \defeq & \tm{\close{a_i}{\wait{b_i}{\close{c_i}{\wait{c'_n}{\close{d}{\halt}}}}}}
    \\
    \tm{\agent{i}}
    & \defeq & \tm{\close{a_i}{\wait{b_i}{\close{c_i}{\halt}}}}
    \\
    \tm{\proc{i}}
    & \defeq & \tm{\wait{a'_i}{\plug{P_i}{\close{b'_i}{Q_i}}}}
  \end{array}
\]

\subsubsection*{Types}
Types $\pcp{\ty{A}}$, $\pcp{\ty{B}}$, $\pcp{\ty{C}}$ in PCP are based on classical linear logic propositions, and are defined by the following grammar:
\[
  \usingnamespace{pcp}
  \begin{array}{lcl}
    \ty{A}, \ty{B}, \ty{C}
    & \Coloneqq & \ty{\tytens[\cs{o}]{A}{B}}
      \sep        \ty{\typarr[\cs{o}]{A}{B}}
      \sep        \ty{\tyone[\cs{o}]}
      \sep        \ty{\tybot[\cs{o}]}
      \sep        \ty{\typlus[\cs{o}]{A}{B}}
      \sep        \ty{\tywith[\cs{o}]{A}{B}}
      \sep        \ty{\tynil[\cs{o}]}
      \sep        \ty{\tytop[\cs{o}]}
  \end{array}
\]
Each connective is annotated with a priority $\cs{o}\in\mathbb{N}$.
The types $\pcp{\ty{\tytens[\cs{o}]{A}{B}}}$ and $\pcp{\ty{\typarr[\cs{o}]{A}{B}}}$ type the endpoints of a channel over which we send or receive a channel of type $\pcp{\ty{A}}$, and then proceed as type $\pcp{\ty{B}}$. The types $\pcp{\ty{\tyone[\cs{o}]}}$ and $\pcp{\ty{{\tybot}[\cs{o}]}}$ type the endpoints of a channel whose session has terminated, and over which we send or receive a \emph{ping} before closing the channel. These two types act as units for $\pcp{\ty{\tytens[\cs{o}]{A}{B}}}$ and $\pcp{\ty{\typarr[\cs{o}]{A}{B}}}$, respectively.

The types $\pcp{\ty{\typlus[\cs{o}]{A}{B}}}$ and $\pcp{\ty{\tywith[\cs{o}]{A}{B}}}$ type the endpoints of a channel over which we can receive or send a choice between two branches $\pcp{\ty{A}}$ or $\pcp{\ty{B}}$. We have opted for a simplified version of choice and followed the original Wadler's CP \cite{wadler12}, however types $\ty{\oplus}$ and $\ty{\with}$ can be trivially generalised to $\pcp{\ty{\oplus^{\cs{o}}\{l_i:A_i\}_{i\in I}}}$ and $\pcp{\ty{\with^{\cs{o}}\{l_i:A_i\}_{i\in I}}}$, respectively, as in the original PCP \cite{dardhagay18}.
The types $\pcp{\ty{\tynil[\cs{o}]}}$ and $\pcp{\ty{\tytop[\cs{o}]}}$ type the endpoints of a channel over which we can send or receive a choice between \emph{no options}. These two types act as units for $\pcp{\ty{\typlus[\cs{o}]{A}{B}}}$ and $\pcp{\ty{\tywith[\cs{o}]{A}{B}}}$, respectively.

\subsubsection*{Environments}
Typing environments $\pcp{\ty{\Gamma}}$, $\pcp{\ty{\Delta}}$ associate names to types. Environments are linear, so two environments can only be combined as $\pcp{\ty{\Gamma}}, \pcp{\ty{\Delta}}$ if their names are distinct, \ie $\pcp{\fv(\ty{\Gamma})\cap\fv(\ty{\Delta})=\varnothing}$.
\[
  \usingnamespace{pcp}
  \begin{array}{lcl}
    \ty{\Gamma}, \ty{\Delta}
    & \Coloneqq & \ty{\emptyenv}
      \sep        \ty{\Gamma}, \tmty{x}{A}
  \end{array}
\]

\subsubsection*{Duality}
Duality is an involutive function on types which preserves priorities:
\[
  \usingnamespace{pcp}
  \setlength{\arraycolsep}{1pt}
  \begin{array}{lcl}
    \ty{\co{(\tyone[\cs{o}])}} & = & \ty{\tybot[\cs{o}]} \\
    \ty{\co{(\tybot[\cs{o}])}} & = & \ty{\tyone[\cs{o}]}
  \end{array}
  \quad
  \begin{array}{lcl}
    \ty{\co{(\tytens[\cs{o}]{A}{B})}} & = & \ty{\typarr[\cs{o}]{\co{A}}{\co{B}}} \\
    \ty{\co{(\typarr[\cs{o}]{A}{B})}} & = & \ty{\tytens[\cs{o}]{\co{A}}{\co{B}}}
  \end{array}
  \quad
  \begin{array}{lcl}
    \ty{\co{(\tynil[\cs{o}])}} & = & \ty{\tytop[\cs{o}]} \\
    \ty{\co{(\tytop[\cs{o}])}} & = & \ty{\tynil[\cs{o}]}
  \end{array}
  \quad
  \begin{array}{lcl}
    \ty{\co{(\typlus[\cs{o}]{A}{B})}} & = & \ty{\tywith[\cs{o}]{\co{A}}{\co{B}}} \\
    \ty{\co{(\tywith[\cs{o}]{A}{B})}} & = & \ty{\typlus[\cs{o}]{\co{A}}{\co{B}}}
  \end{array}
\]

\subsubsection*{Priorities}
The function $\pr(\cdot)$ returns smallest priority of a type. As with PGV, the type system guarantees that the top-most connective always holds the smallest priority.  The function $\minpr(\cdot)$ returns the \emph{minimum} priority of all types a typing context, or $\cs{\ptop}$ if the context is empty:
\[
  \usingnamespace{pcp}
  \setlength{\arraycolsep}{1pt}
  \begin{array}{lclclcl}
    \pr(\ty{\tyone[\cs{o}]})        & = & \cs{o} \\
    \pr(\ty{\tybot[\cs{o}]})        & = & \cs{o}
  \end{array}
  \qquad
  \begin{array}{lclclcl}
    \pr(\ty{\tytens[\cs{o}]{A}{B}}) & = & \cs{o} \\
    \pr(\ty{\typarr[\cs{o}]{A}{B}}) & = & \cs{o}
  \end{array}
  \qquad
  \begin{array}{lclclcl}
    \pr(\ty{\tynil[\cs{o}]})        & = & \cs{o} \\
    \pr(\ty{\tytop[\cs{o}]})        & = & \cs{o}
  \end{array}
  \qquad
  \begin{array}{lclclcl}
    \pr(\ty{\typlus[\cs{o}]{A}{B}}) & = & \cs{o} \\
    \pr(\ty{\tywith[\cs{o}]{A}{B}}) & = & \cs{o} 
  \end{array}
\]
\[
    \minpr(\ty{\emptyenv})          = \cs{\ptop}
    \qquad
    \minpr(\ty{\Gamma},\tmty{x}{A}) = \minpr(\ty{\Gamma})\sqcap\minpr(\ty{A})
\]

\subsubsection*{Terms}
We let $\pcp{\tm{P}}$, $\pcp{\tm{Q}}$ range over processes, produced by the following grammar.
\[
  \usingnamespace{pcp}
  \begin{array}[t]{lcl}
    \tm{P}, \tm{Q}
    & \Coloneqq & \tm{\link{x}{y}}
           \sep   \tm{\res{x}{y}{P}}
           \sep   \tm{(\ppar{P}{Q})}
           \sep   \tm{\halt}
    \\   & \sep & \tm{\send{x}{y}{P}}
           \sep   \tm{\close{x}{P}}
           \sep   \tm{\recv{x}{y}{P}}
           \sep   \tm{\wait{x}{P}}
    \\   & \sep & \tm{\inl{x}{P}}
           \sep   \tm{\inr{x}{P}}
           \sep   \tm{\offer{x}{P}{Q}}
           \sep   \tm{\absurd{x}}
  \end{array}
\]
The process $\pcp{\tm{\link{x}{y}}}$ links endpoints $\pcp{\tm{x}}$ and $\pcp{\tm{y}}$ and forwards communication from one to the other. $\pcp{\tm{\res{x}{y}{P}}}$, $\pcp{\tm{(\ppar{P}{Q})}}$ and $\pcp{\tm{\halt}}$ denote respectively the restriction processes where channel endpoints $\pcp{\tm{x}}$ and $\pcp{\tm{y}}$ are bound together and with scope $\pcp{\tm{P}}$, the parallel composition of processes $\pcp{\tm{P}}$ and $\pcp{\tm{Q}}$ and the terminated process.

Processes $\pcp{\tm{\send{x}{y}{P}}}$ and $\pcp{\tm{\recv{x}{y}{P}}}$ send or receive over channel $\pcp{\tm{x}}$ a value $\pcp{\tm{y}}$ and proceed as process $\pcp{\tm{P}}$. The processes $\pcp{\tm{\close{x}{P}}}$ and $\pcp{\tm{\wait{x}{P}}}$ send and receive an empty value---denoting the closure of channel $\pcp{\tm{x}}$, and continue as $\pcp{\tm{P}}$.

Processes $\pcp{\tm{\inl{x}{P}}}$ and $\pcp{\tm{\inr{x}{P}}}$ make a left and right choice, respectively and proceed as process $\pcp{\tm{P}}$. Dually, $\pcp{\tm{\offer{x}{P}{Q}}}$ offers both left and right branches, with continuations $\pcp{\tm{P}}$ and $\pcp{\tm{Q}}$, and $\pcp{\tm{\absurd{x}}}$ is the empty offer.

We write \emph{unbound} send as $\pcp{\tm{\usend{x}{y}{P}}}$, which is syntactic sugar for $\pcp{\tm{\send{x}{z}{(\ppar{\link{y}{z}}{P})}}}$. Alternatively, we could take $\pcp{\tm{\usend{x}{y}{P}}}$ as primitive, and let $\pcp{\tm{\send{x}{y}{P}}}$ be syntactic sugar for $\pcp{\tm{\res{y}{z}{(\usend{x}{z}{P})}}}$. CP takes \emph{bound} sending as primitive, as it is impossible to eliminate the top-level cut in terms such as $\pcp{\tm{\res{y}{z}{(\usend{x}{z}{P})}}}$, even with communting conversions. In our setting without commuting conversions and with more permissive normal forms, this is no longer an issue, but, for simplicity, we keep bound sending as primitive.

\subsubsection*{Operational Semantics}
The operational semantics for PCP, given in \cref{fig:pcp-operational-semantics}, is defined as a reduction relation $\pcp{\red}$ on processes (bottom) and uses structural congruence (top). Each of the axioms of structural congruence corresponds to the axiom of the same name for PGV. We write $\pcp{\red^+}$ for the transitive closures, and $\pcp{\red^\star}$ for the reflexive-transitive closures.\simon{Maybe worth highlighting that it is an internal mobility calculus, for the pi calculus people.}

The reduction relation is given by a set of axioms and inference rules for context closure. Reduction occurs under restriction. $\LabTirName{E-Link}$ reduces a parallel composition with a link into a substitution. $\LabTirName{E-Send}$ is the main communication rule, where send and receive processes sychronise and reduce to the corresponding continuations. $\LabTirName{E-Close}$ follows the previous rule and it closes the channel identified by endpoints $\pcp{\tm{x}}$ and $\pcp{\tm{y}}$. $\LabTirName{E-Select-Inl}$ and $\LabTirName{E-Select-Inr}$ are generalised versions of $\LabTirName{E-Send}$. They state respectively that a left and right selection synchronises with a choice offering and reduces to the corresponding continuations. The last three rules state that reduction is closed under restriction, parallel composition and structural congruence, respectively. 

\input{fig/pcp-operational-semantics}

\subsubsection*{Typing}
\Cref{fig:pcp-typing} gives the typing rules for our version of PCP. A typing judgement $\pcp{\seq{P}{\Gamma}}$ states that ``process $\pcp{\tm{P}}$ is well typed under the typing context $\pcp{\ty{\Gamma}}$''.

Typing rules make use of priorities, defined in the previous section. \textsc{T-Link} states that the link process $\pcp{\tm{\link{x}{y}}}$ is well typed under channels $\pcp{\tm{x}}$ and $\pcp{\tm{y}}$ having dual types, respectively $\pcp{\ty{A}}$ and $\pcp{\ty{\co{A}}}$. \textsc{T-Res} sates that the restriction process $\pcp{\tm{\res{x}{y}{P}}}$ is well typed under typing context $\pcp{\ty{\Gamma}}$ if process $\pcp{\tm{P}}$ is well typed in $\pcp{\ty{\Gamma}}$ augmented with channel endpoints $\pcp{\tm{x}}$ and $\pcp{\tm{y}}$ having dual types, respectively $\pcp{\ty{A}}$ and $\pcp{\ty{\co{A}}}$. \textsc{T-Par} states that the parallel composition of processes $\pcp{\tm{P}}$ and $\pcp{\tm{Q}}$ is well typed under the disjoint union of their respective typing contexts. \textsc{T-Halt} states that the terminated process $\pcp{\tm{\halt}}$ is well typed in the empty context.

\textsc{T-Send} and \textsc{T-Recv} state that the sending and receiving of a bound name $\pcp{\tm{y}}$ over a channel $\pcp{\tm{x}}$ is well typed under $\pcp{\ty{\Gamma}}$ and $\pcp{\tm{x}}$ of type $\pcp{\ty{\tytens[\cs{o}]{A}{B}}}$, respectively $\pcp{\typarr[\cs{o}]{A}{B}}$. Priority $\cs{o}$ is the smallest among all priorities of the types used by the output or input process, captured by the side condition $\pcp{\cs{o}<\minpr(\ty{\Gamma},\ty{A},\ty{B})}$.

Rules \textsc{T-Close} and \textsc{T-Wait} type the closure of channel $\pcp{\tm{x}}$ and are in the same lines as the previous two rules, requiring that the priority of channel $\pcp{\tm{x}}$ is the smallest among all priorities in $\pcp{\ty{\Gamma}}$.

\textsc{T-Select-Inl} and \textsc{T-Select-Inr} type respectively the left $\pcp{\tm{\inl{x}{P}}}$ and right $\pcp{\tm{\inr{x}{P}}}$ choice performed on channel $\pcp{\tm{x}}$. \textsc{T-Offer} and \textsc{T-Offer-Absurd} type the offering of a choice, or empty choice, on channel $\pcp{\tm{x}}$. In all the above rules the priority $\cs{o}$ of channel $\pcp{\tm{x}}$ is the smallest with respect to the typing context $\pcp{\cs{o}<\minpr(\ty{\Gamma})}$ and types involved in the choice $\pcp{\cs{o}<\minpr(\ty{\Gamma},\ty{A},\ty{B})}$.

\input{fig/pcp-typing}


\subsubsection*{Metatheory}
Reduction in our version of PCP preserve types. Since our reduction relation is a strict subset of the reduction relation in the original~\cite{dardhagay18}, we defer to their proofs. We prove progress for our version of PCP, see~\cref{prf:thm-pcp-closed-progress}.

\subsubsection*{Translation}
We illustrate the relation between PCP and PGV by giving a translation from PCP to PGV. The translation on types is defined as follows:
\[
  \begin{array}{lcl}
    \ty{\cpgvT{\pcp{\tytens[\cs{o}]{A}{B}}}}
    & = & \pgv{\ty{\tysend[\cs{o}]{\co{\cpgvT{A}}}{\cpgvT{B}}}}
    \\
    \ty{\cpgvT{\pcp{\typlus[\cs{o}]{A}{B}}}}
    & = & \pgv{\ty{\tyselect[\cs{o}]{\cpgvT{A}}{\cpgvT{B}}}}
  \end{array}
  \;
  \begin{array}{lcl}
    \ty{\cpgvT{\pcp{\tyone[\cs{o}]}}}
    & = & \ty{\pgv{\tyends[\cs{o}]}}
    \\
    \ty{\cpgvT{\pcp{\tynil[\cs{o}]}}}
    & = & \pgv{\ty{\tyselectemp[\cs{o}]}}
  \end{array}
  \;
  \begin{array}{lcl}
    \ty{\cpgvT{\pcp{\typarr[\cs{o}]{A}{B}}}}
    & = & \pgv{\ty{\tyrecv[\cs{o}]{\cpgvT{A}}{\cpgvT{B}}}}
    \\
    \ty{\cpgvT{\pcp{\tywith[\cs{o}]{A}{B}}}}
    & = & \pgv{\ty{\tyoffer[\cs{o}]{\cpgvT{A}}{\cpgvT{B}}}}
  \end{array}
  \;
  \begin{array}{lcl}
    \ty{\cpgvT{\pcp{\tybot[\cs{o}]}}}
    & = & \ty{\pgv{\tyendr[\cs{o}]}}
    \\
    \ty{\cpgvT{\pcp{\tytop[\cs{o}]}}}
    & = & \pgv{\ty{\tyofferemp[\cs{o}]}}
  \end{array}
\]
There are two separate translations on processes. The first, $\tm{\cpgvC{\cdot}}$, translates processes to \emph{configurations}. It translates as much as possible of the process to the corresponding configuration constructs. Once it hits the first action, it switches to the second translation, $\tm{\cpgvM{\cdot}}$, which translates processes to \emph{terms}:
\[
  \begin{array}{lcl}
    \pcp{\tm{\cpgvC{\res{x}{y}{P}}}}
    & = & \pgv{\tm{\res{x}{y}{\cpgvC{P}}}} \\
    \pcp{\tm{\cpgvC{\ppar{P}{Q}}}}
    & = & \pgv{\tm{\ppar{\cpgvC{P}}{\cpgvC{Q}}}} \\
    \pcp{\tm{\cpgvC{\send{x}{y}{P}}}}
    & = & \pgv{\tm{\res{y}{z}{(\child\;\letbind{x}{\send\;\pair{z}{x}}{\cpgvM{P}})}}} \\
    \pcp{\tm{\cpgvC{\inl{x}{P}}}}
    & = & \pgv{\tm{\res{y}{z}{(\child\;\letbind{x}{\andthen{\close\;(\send\;\pair{\inl{y}}{x})}{z}}{\cpgvM{P}})}}} \\
    \pcp{\tm{\cpgvC{\inr{x}{P}}}}
    & = & \pgv{\tm{\res{y}{z}{(\child\;\letbind{x}{\andthen{\close\;(\send\;\pair{\inr{y}}{x})}{z}}{\cpgvM{P}})}}} \\
    \pcp{\tm{\cpgvC{P}}}
    & = & \pgv{\tm{\child{\cpgvM{P}}}},\hfill\text{if none of the above apply}\\
    \\
    \pcp{\tm{\cpgvM{\link{x}{y}}}}
    & = & \pgv{\tm{\link\;{\pair{x}{y}}}} \\
    \pcp{\tm{\cpgvM{\res{x}{y}{P}}}}
    & = & \pgv{\tm{\letpair{x}{y}{\new}{\cpgvM{P}}}} \\
    \pcp{\tm{\cpgvM{\ppar{P}{Q}}}}
    & = & \pgv{\tm{\andthen{\spawn\;{(\lambda\unit.\cpgvM{P})}}{\cpgvM{Q}}}} \\
    \pcp{\tm{\cpgvM{\halt}}}
    & = & \pgv{\tm{\unit}} \\
    \pcp{\tm{\cpgvM{\close{x}{P}}}}
    & = & \pgv{\tm{\andthen{\close\;{x}}{\cpgvM{P}}}} \\
    \pcp{\tm{\cpgvM{\wait{x}{P}}}}
    & = & \pgv{\tm{\andthen{\wait\;{x}}{\cpgvM{P}}}} \\
    \pcp{\tm{\cpgvM{\send{x}{y}{P}}}}
    & = & \pgv{\tm{\letpair{y}{z}{\new}{\letbind{x}{\send\;{\pair{z}{x}}}{\cpgvM{P}}}}} \\
    \pcp{\tm{\cpgvM{\recv{x}{y}{P}}}}
    & = & \pgv{\tm{\letpair{y}{x}{\recv\;{x}}{\cpgvM{P}}}} \\
    \pcp{\tm{\cpgvM{\inl{x}{P}}}}
    & = & \pgv{\tm{\letbind{x}{\select{\labinl}\;{x}}{\cpgvM{P}}}} \\
    \pcp{\tm{\cpgvM{\inr{x}{P}}}}
    & = & \pgv{\tm{\letbind{x}{\select{\labinr}\;{x}}{\cpgvM{P}}}} \\
    \multicolumn{3}{l}{\pcp{\tm{\cpgvM{\offer{x}{P}{Q}}}}} \\
    & = & \pgv{\tm{\offer{x}{x}{\cpgvM{P}}{x}{\cpgvM{Q}}}} \\
    \pcp{\tm{\cpgvM{\absurd{x}}}}
    & = & \pgv{\tm{\offeremp{x}}}
  \end{array}
\]
The third, fourth, and fifth cases for $\tm{\cpgvC{\cdot}}$ translate the $\nu$-binders implicit in the encoding of bound sending to configuration constructs, which is required for completeness of the operational correspondence.
Typing environments are translated pointwise, and sequents $\pcp{\seq{P}{\ty{\Gamma}}}$ are translated as $\pgv{\cseq[\child]{\ty{\cpgvT{\ty{\Gamma}}}}{\cpgvC{P}}}$.

Recall our implementations of Milner's cyclic scheduler in PCP ($\pcp{\tm{\sched}}$, \cref{sec:pcp-example}) and PGV ($\pgv{\tm{\sched}}$, \cref{sec:pgv-example}). The translation of $\pcp{\tm{\sched}}$ is exactly $\pgv{\tm{\sched}}$ where all processes are child processes.

The translations $\tm{\cpgvC{\cdot}}$ and $\tm{\cpgvM{\cdot}}$ are preserve typing. The proofs are standard inductions. The details can be found in~\cref{prf:lem-pcp-to-pgv-terms-preservation,prf:lem-pcp-to-pgv-terms-preservation}:
\begin{compacttheorems}
  \begin{restatablelemma}{lempcptopgvtermspreservation}[Preservation, ${\tm{\cpgvM{\cdot}}}$]
    \label{lem:pcp-to-pgv-terms-preservation}
    If $\pcp{\seq{P}{\ty{\Gamma}}}$, then $\pgv{\tseq[\cs{p}]{\ty{\cpgvT{\Gamma}}}{\cpgvM{P}}{\tyunit}}$.
  \end{restatablelemma}
  \begin{restatabletheorem}{thmpcptopgvconfspreservation}[Preservation, ${\tm{\cpgvC{\cdot}}}$]
    \label{thm:pcp-to-pgv-confs-preservation}
    If $\pcp{\seq{P}{\ty{\Gamma}}}$, then $\pgv{\cseq[\child]{\ty{\cpgvT{\Gamma}}}{\cpgvC{P}}}$.
  \end{restatabletheorem}
\end{compacttheorems}

Our translation satisfies operational correspondence. We link our translations, and show that $\tm{\cpgvM{P}}$ \emph{must} reduce to $\tm{\cpgvC{P}}$, \ie $\tm{\cpgvC{\cdot}}$ is equivalent to translating with $\tm{\cpgvM{\cdot}}$ and performing several reduction steps. We use this fact to prove operational correspondence. The details are in~\cref{prf:lem-pcp-to-pgv-cpgvM-to-cpgvC,prf:thm-pcp-to-pgv-operational-correspondence-completeness,prf:thm-pcp-to-pgv-operational-correspondence-soundness}:
\begin{compacttheorems}
  \begin{restatablelemma}{lempcptopgvcpgvMtocpgvC}
    \label{lem:pcp-to-pgv-cpgvM-to-cpgvC}
    For any $\pcp{\tm{P}}$, either:
    \begin{itemize}
    \item $\pgv{\tm{\child\;\cpgvM{P}}=\tm{\cpgvC{P}}}$; or
    \item   $\pgv{\tm{\child\;\cpgvM{P}}\cred^+\tm{\cpgvC{P}}}$, and for any $\pgv{\tm{\conf{C}}}$, if $\pgv{\tm{\child\;\cpgvM{P}}\cred\tm{\conf{C}}}$, then $\pgv{\tm{\conf{C}}\cred^\star\tm{\cpgvC{P}}}$.
    \end{itemize}
  \end{restatablelemma}
  \begin{restatabletheorem}{thmpcptopgvoperationalcorrespondencecompleteness}%
    [Operational Correspondence, Completeness, ${\tm{\cpgvC{\cdot}}}$]
    \label{thm:pcp-to-pgv-operational-correspondence-completeness}
    \hfill\\%newline before theorem statement
    If $\pcp{\seq{P}{\ty{\Gamma}}}$ and $\pcp{\tm{P}\red\tm{Q}}$,
    then $\pgv{\tm{\cpgvC{P}}\cred^+\tm{\cpgvC{Q}}}$. Details in~\cref{prf:lem-pcp-to-pgv-cpgvM-to-cpgvC}.
  \end{restatabletheorem}
  % \begin{proof}
  %   By induction on the derivation of $\pcp{\tm{P}\red\tm{Q}}$. We apply \cref{lem:pcp-to-pgv-cpgvM-to-cpgvC} for the cases in which the translation switches from $\tm{\cpgvC{\cdot}}$ to $\tm{\cpgvM{\cdot}}$, \ie under actions. We apply \cref{lem:pcp-to-pgv-confs-operational-correspondence-equiv} for \LabTirName{E-LiftSC}. Details in \cref{prf:thm-pcp-to-pgv-operational-correspondence-completeness}.
  % \end{proof}
  \begin{restatabletheorem}{thmpcptopgvoperationalcorrespondencesoundness}%
    [Operational Correspondence, Soundness, ${\tm{\cpgvC{\cdot}}}$]
    \label{thm:pcp-to-pgv-operational-correspondence-soundness}
    \hfill\\%newline before theorem statement
    If $\pcp{\seq{P}{\ty{\Gamma}}}$ and $\pgv{\tm{\cpgvC{P}}\cred\tm{\conf{C}}}$, there exists a $\tm{Q}$ such that $\pcp{\tm{P}\red^+\tm{Q}}$ and $\pgv{\tm{\conf{C}}\cred^\star\tm{\cpgvC{Q}}}$
  \end{restatabletheorem}
  % \begin{proof}
  %   By induction on the derivation of $\pgv{\tm{\cpgvC{P}}\cred\tm{\conf{C}}}$.\simon{Surprising that you can get it by the derivation of the reduction relation---normally, 'soundness' would be proved by shunting into a canonical form and then proceeding by induction the structure of the term / induction on typing derivations.}
  %   Details in \cref{prf:thm-pcp-to-pgv-operational-correspondence-soundness}.
  % \end{proof}
\end{compacttheorems}

\end{document}

%%% Local Variables:
%%% TeX-master: "priorities"
%%% End:
