\documentclass[main.tex]{subfiles}

\begin{document}

\section{Priority GV}
\usingnamespace{pgv}

\paragraph*{Priorities, types, and environments}
\[
  \cs{o}, \cs{p}, \cs{q}, \cs{r} \in \mathbb{N}\cup\{\cs{\pbot},\cs{\ptop}\}
\]
\[
\begin{array}{lcl}
  \ty{S}
  & \coloneqq & \ty{\tysend[\cs{o}]{T}{S}}
    \sep        \ty{\tyrecv[\cs{o}]{T}{S}}
    \sep        \ty{\tyends[\cs{o}]}
    \sep        \ty{\tyendr[\cs{o}]}
  \\
  \ty{T}, \ty{U}
  & \coloneqq & \ty{\tyunit}
    \sep        \ty{\tyvoid}
    \sep        \ty{\typrod{T}{U}}
    \sep        \ty{\tysum{T}{U}}
    \sep        \ty{\tylolli[\cs{p},\cs{q}]{T}{U}}
    \sep        \ty{S}
  \\
  \ty{\Gamma}, \ty{\Delta}
  & \coloneqq & \ty{\emptyenv}
    \sep        \ty{\Gamma}, \tmty{x}{T}
\end{array}
\]
\[
\begin{array}{lcl}
  \ty{\co{\tysend[\cs{o}]{T}{S}}} & = & \ty{\tyrecv[\cs{o}]{T}{\co{S}}} \\
  \ty{\co{\tyrecv[\cs{o}]{T}{S}}} & = & \ty{\tysend[\cs{o}]{T}{\co{S}}}
\end{array}
\qquad
\begin{array}{lcl}
  \ty{\co{\tyends[\cs{o}]}} & = & \ty{\co{\tyendr[\cs{o}]}} \\
  \ty{\co{\tyendr[\cs{o}]}} & = & \ty{\co{\tyends[\cs{o}]}}
\end{array}
\]
\[
\begin{array}{lcl}
  \pr(\ty{\tysend[\cs{o}]{T}{S}}) & = & \cs{o} \\
  \pr(\ty{\tyrecv[\cs{o}]{T}{S}}) & = & \cs{o} \\
  \pr(\ty{\typrod{T}{U}}) & = & \pr({\ty{T}})\sqcap\pr({\ty{U}}) \\
  \pr(\ty{\tysum{T}{U}})  & = & \pr({\ty{T}})\sqcap\pr({\ty{U}}) \\
  \pr(\ty{\tylolli[\cs{p},\cs{q}]{T}{U}}) & = & \cs{p} \\
  \pr(\ty{\Gamma}, \tmty{x}{A}) & = & \pr(\ty{\Gamma})\sqcap\pr(\ty{A})
\end{array}
\qquad
\begin{array}{lcl}
  \pr(\ty{\tyends[\cs{o}]}) & = & \cs{o} \\
  \pr(\ty{\tyendr[\cs{o}]}) & = & \cs{o} \\
  \pr(\ty{\tyunit})         & = & \ptop \\
  \pr(\ty{\tyvoid})         & = & \ptop \\
  \pr(\ty{S})               & = & \pr(\ty{S}) \\
  \pr(\ty{\emptyenv})       & = & \ptop
\end{array}
\]

\paragraph*{Syntactic Sugar for Types}
\[
  \ty{\tylolli{T}{U}} \elabarrow \ty{\tylolli[\cs{\ptop},\cs{\pbot}]{T}{U}}
\]

\paragraph*{Static Term Syntax}
\[
\begin{array}{lcl}
  \tm{L}, \tm{M}, \tm{N}
  & \coloneqq & \tm{x}
    \sep        \tm{K}
    \sep        \tm{\lambda x.M}
    \sep        \tm{M\;N} \\
  & \sep      & \tm{\unit}
    \sep        \tm{\letunit{M}{N}} \\
  & \sep      & \tm{\pair{M}{N}}
    \sep        \tm{\letpair{x}{y}{M}{N}} \\
  & \sep      & \tm{\inl{M}}
    \sep        \tm{\inr{M}}
    \sep        \tm{\casesum{L}{x}{M}{y}{N}} \\
  & \sep      & \tm{\absurd{M}} \\
  \tm{K}
  & \coloneqq & \tm{\link}
    \sep        \tm{\new}
    \sep        \tm{\spawn}
    \sep        \tm{\send}
    \sep        \tm{\recv}
    \sep        \tm{\wait}
    \sep        \tm{\close}
\end{array}
\]

\paragraph*{Syntactic Sugar for Terms}
\[
\begin{array}{lcl}
  \tm{\andthen{M}{N}}
  & \elabarrow & \tm{\letunit{M}{N}} \\
  \tm{\letbind{x}{M}{N}}
  & \elabarrow & \tm{(\lambda x.N)\;M} \\
  \tm{\lambda\unit.M}
  & \elabarrow & \tm{\lambda z.\letunit{z}{M}} \\
  \tm{\lambda\pair{x}{y}.M}
  & \elabarrow & \tm{\lambda z.\letpair{x}{y}{z}{M}} \\
  \tm{\fork}
  & \elabarrow & \tm{\lambda x.\letpair{y}{z}{\new}{\andthen{\spawn\;{(\lambda\unit.x\;y)}}{z}}}
\end{array}
\]

\paragraph*{Syntactic Sugar for Internal and External Choice}
\[
\begin{array}{lcl}
  \ty{\tyselect[\cs{o}]{S}{S'}}
  & \elabarrow & \ty{\tysend[\cs{o}]{(\tysum{\co{S}}{\co{S'}})}{\tyends[\cs{o+1}]}} \\
  \ty{\tyoffer[\cs{o}]{S}{S'}}
  & \elabarrow & \ty{\tyrecv[\cs{o}]{(\tysum{S}{S'})}{\tyendr[\cs{o+1}]}} \\
\end{array}
\qquad
\begin{array}{lcl}
  \ty{\tyselectemp[\cs{o}]}
  & \elabarrow & \ty{\tysend[\cs{o}]{\tyvoid}{\tyends[\cs{o+1}]}} \\
  \ty{\tyofferemp[\cs{o}]}
  & \elabarrow & \ty{\tyrecv[\cs{o}]{\tyvoid}{\tyendr[\cs{o+1}]}} \\
\end{array}
\]
\[
\begin{array}{lcl}
  \tm{\select{\ell}}
  & \elabarrow & \tm{\lambda x.\letpair{y}{z}{\new}{\andthen{\close\;(\send\;{\pair{\ell\;y}{x}})}{z}}} \\
  \multicolumn{3}{l}{\tm{\offer{L}{x}{M}{y}{N}}\elabarrow} \\
  \multicolumn{3}{l}{
  \qquad\tm{\letpair{z}{w}{\recv\;{L}}{\andthen{\wait\;{w}}{\casesum{z}{x}{M}{y}{N}}}}} \\
  \tm{\offeremp{L}}
  & \elabarrow & \tm{\letpair{z}{w}{\recv\;L}{\andthen{\wait\;{w}}{\absurd{z}}}}
\end{array}
\]

\paragraph*{Runtime Term Syntax}
\[
\begin{array}[t]{lcl}
  \tm{\conf{C}}, \tm{\conf{D}}, \tm{\conf{E}}
  & \coloneqq & \tm{\phi\;M}
    \sep        \tm{\ppar{\conf{C}}{\conf{D}}}
    \sep        \tm{\res{x}{y}{\conf{C}}}
  \\
  \tm{\phi}
  & \coloneqq & \tm{\main}
    \sep        \tm{\child}
  \\
  \tm{V}, \tm{W}
  & \coloneqq & \tm{\lambda x.M}
    \sep        \tm{\unit}
    \sep        \tm{\pair{M}{N}}
    \sep        \tm{\inl{M}}
    \sep        \tm{\inr{M}}
  \\
  \tm{R}
  & \coloneqq & \tm{\link\;\pair{V}{W}}
    \sep        \tm{\new}
    \sep        \tm{\spawn\;V} \\
  & \sep      & \tm{\send\;\pair{V}{W}}
    \sep        \tm{\recv\;V}
    \sep        \tm{\close\;V}
    \sep        \tm{\wait\;V}
  \\
  \tm{E}
  & \coloneqq & \tm{\hole} \\
  & \sep      & \tm{E\;M}
    \sep        \tm{V\;E} \\
  & \sep      & \tm{\letunit{E}{N}} \\
  & \sep      & \tm{\pair{E}{M}}
    \sep        \tm{\pair{V}{E}}
    \sep        \tm{\letpair{x}{y}{E}{M}} \\
  & \sep      & \tm{\inl{E}}
    \sep        \tm{\inr{E}}
    \sep        \tm{\casesum{E}{x}{M}{y}{N}} \\
  \\
  \tm{\conf{F}}
  & \coloneqq & \tm{\phi\;E}
  \\
  \tm{\conf{G}}
  & \coloneqq & \tm{\hole} \\
  & \sep      & \tm{\ppar{\conf{G}}{\conf{C}}}
    \sep        \tm{\res{x}{y}{\conf{G}}}
\end{array}
\]
\[
\begin{array}{ll}
  \tm{\main}  + \tm{\child} = \tm{\main}
  \\
  \tm{\child} + \tm{\main}  = \tm{\main}
\end{array}
\quad
\begin{array}{ll}
  \tm{\child} + \tm{\child} = \tm{\child}
  \\
  \tm{\main}  + \tm{\main} \; \text{undefined}
\end{array}
\]

\subsection{Typing}
\input{fig/pgv-typing}
See \cref{fig:pgv-typing}.

\subsection{Operational Semantics}
\input{fig/pgv-operational-semantics}
See \cref{fig:pgv-operational-semantics}.

\subsection{Metatheory}

\begin{restatablelemma}{lempgvvaluedone}
  \label{lem:pgv-value-done}
  If $\tseq[\cs{o}]{\ty{\Gamma}}{V}{T}$, then $\cs{o}=\cs{\pbot}$, and $\pr(\ty{\Gamma})=\pr(\ty{T})$.
\end{restatablelemma}
\begin{proof}
  By induction on the derivation of $\tseq[\cs{o}]{\ty{\Gamma}}{V}{T}$.
  (Details in \cref{prf:lem-pgv-value-done}.)
\end{proof}

\begin{restatablelemma}{lempgvsubstitution}[Substitution]
  \label{lem:pgv-substitution}
  \hfill\\%newline before theorem statement
  If $\tseq[\cs{p}]{\ty{\Gamma},\tmty{x}{U'}}{M}{T}$ and $\tseq[\cs{q}]{\ty{\Theta}}{V}{U'}$, then $\tseq[\cs{p}]{\ty{\Gamma},\ty{\Theta}}{\subst{M}{V}{x}}{T}$.
\end{restatablelemma}
\begin{proof}
  By induction on the derivation of $\tseq[\cs{p}]{\ty{\Gamma},\tmty{x}{U'}}{M}{T}$. Whenever the contexts in the premises and conclusion differ, we use \cref{lem:pgv-value-done} to prove that the priorities are preserved.
  (Details in \cref{prf:lem-pgv-substitution}.)
\end{proof}

\begin{restatablelemma}{lempgvsubjectreductionterms}[Subject Reduction, $\tred$]
  \label{lem:pgv-subject-reduction-terms}
  \hfill\\%newline before theorem statement
  If $\tseq[\cs{o}]{\ty{\Gamma}}{M}{T}$ and $\tm{M}\tred\tm{M'}$,
  then $\tseq[\cs{o}]{\ty{\Gamma}}{M'}{T}$.
\end{restatablelemma}
\begin{proof}
  By induction on the derivation of $\tm{M}\tred\tm{M'}$.
  (Details in \cref{prf:lem-pgv-subject-reduction-terms}.)
\end{proof}

\begin{restatablelemma}{lempgvsubjectcongruence}[Subject Congruence, $\equiv$]
  \label{lem:pgv-subject-congruence}
  \hfill\\%newline before theorem statement
  If $\cseq[\phi]{\ty{\Gamma}}{\conf{C}}$ and $\tm{\conf{C}}\equiv\tm{\conf{C'}}$,
  then $\cseq[\phi]{\ty{\Gamma}}{\conf{C'}}$.
\end{restatablelemma}
\begin{proof}
  By induction on the derivation of $\tm{\conf{C}}\equiv\tm{\conf{C'}}$.
  (Details in \cref{prf:lem-pgv-subject-congruence}.)
\end{proof}

\begin{restatabletheorem}{thmpgvsubjectreductionconfs}[Subject Reduction, $\cred$]
  \label{thm:pgv-subject-reduction-confs}
  \hfill\\%newline before theorem statement
  If $\cseq[\phi]{\ty{\Gamma}}{\conf{C}}$ and $\tm{\conf{C}}\cred\tm{\conf{C'}}$,
  then $\cseq[\phi]{\ty{\Gamma}}{\conf{C'}}$.
\end{restatabletheorem}
\begin{proof}
  By induction on the derivation of $\tm{\conf{C}}\cred\tm{\conf{C'}}$.
  (Details in \cref{prf:thm-pgv-subject-reduction-confs}.)
\end{proof}

\begin{restatablelemma}{lempgvopenprogressterms}[Open Progress, $\tred$]
  \label{lem:pgv-open-progress-terms}
  If $\tseq[\cs{o}]{\ty{\Gamma}}{M}{T}$, then either:
  \begin{description}[labelwidth=8ex]
  \item[Done]
    $\tm{M}$ is a value;
  \item[Step]
    There exists some $\tm{N}$ such that $\tm{M}\tred\tm{N}$; or
  \item[Blocked]
    There exists some $\tm{E}$ and $\tm{R}$ such that $\tm{M}=\tm{\plug{E}{R}}$.
  \end{description}
\end{restatablelemma}
\begin{proof}
  \admit
\end{proof}

\begin{restatabletheorem}{thmpgvopenprogressconfs}[Open Progress, $\cred$]
  \label{thm:pgv-open-progress-confs}
  If $\cseq[\phi]{\ty{\Gamma}}{\conf{C}}$, then either:
  \begin{description}[labelwidth=8ex]
  \item[Done]
    There exists some $\tm{V}$ such that $\tm{\conf{C}}=\tm{\phi\;V}$;
  \item[Step]
    There exists some $\tm{\conf{D}}$ such that $\tm{\conf{C}} \cred \tm{\conf{D}}$; or
  \item[Blocked]
    We have $\tm{\conf{C}}\equiv\tm{\res{x_1y_1\dots x_ny_n}{}{(\phi_1R_1 \parallel\dots\parallel \phi_mR_m)}}$,\\
    and for some $\tm{R_j}$ and $\tm{a_j}\in\fn(\ty{\Gamma})$, $\blocked(\tm{a_j},\tm{R_j})$.
  \end{description}
\end{restatabletheorem}
\begin{proof}
  \admit
\end{proof}

\end{document}

%%% Local Variables:
%%% TeX-master: "priorities"
%%% End:
