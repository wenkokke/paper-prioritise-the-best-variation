\documentclass[main.tex]{subfiles}

\begin{document}

\section{Priority GV}
\usingnamespace{pgv}

\subsection{Syntax}

\paragraph*{Priorities, types, and environments}
\[
  \cs{o}, \cs{p}, \cs{q}, \cs{r} \in \mathbb{N}\cup\{\cs{\pbot},\cs{\ptop}\}
\]
\[
\begin{array}{lcl}
  \ty{S}
  & \coloneqq & \ty{\tysend[\cs{o}]{T}{S}}
    \sep        \ty{\tyrecv[\cs{o}]{T}{S}}
    \sep        \ty{\tyends[\cs{o}]}
    \sep        \ty{\tyendr[\cs{o}]}
  \\
  \ty{T}, \ty{U}
  & \coloneqq & \ty{\tyunit}
    \sep        \ty{\tyvoid}
    \sep        \ty{\typrod{T}{U}}
    \sep        \ty{\tysum{T}{U}}
    \sep        \ty{\tylolli[\cs{p},\cs{q}]{T}{U}}
    \sep        \ty{S}
  \\
  \ty{\Gamma}, \ty{\Delta}
  & \coloneqq & \ty{\emptyenv}
    \sep        \ty{\Gamma}, \tmty{x}{T}
\end{array}
\]
\[
\begin{array}{lcl}
  \ty{\co{\tysend[\cs{o}]{T}{S}}} & = & \ty{\tyrecv[\cs{o}]{T}{\co{S}}} \\
  \ty{\co{\tyrecv[\cs{o}]{T}{S}}} & = & \ty{\tysend[\cs{o}]{T}{\co{S}}}
\end{array}
\qquad
\begin{array}{lcl}
  \ty{\co{\tyends[\cs{o}]}} & = & \ty{\co{\tyendr[\cs{o}]}} \\
  \ty{\co{\tyendr[\cs{o}]}} & = & \ty{\co{\tyends[\cs{o}]}}
\end{array}
\]
\[
\begin{array}{lcl}
  \pr(\ty{\tysend[\cs{o}]{T}{S}}) & = & \cs{o} \\
  \pr(\ty{\tyrecv[\cs{o}]{T}{S}}) & = & \cs{o} \\
  \pr(\ty{\typrod{T}{U}}) & = & \pr({\ty{T}})\sqcap\pr({\ty{U}}) \\
  \pr(\ty{\tysum{T}{U}})  & = & \pr({\ty{T}})\sqcap\pr({\ty{U}}) \\
  \pr(\ty{\tylolli[\cs{p},\cs{q}]{T}{U}}) & = & \cs{p} \\
  \pr(\ty{\Gamma}, \tmty{x}{A}) & = & \pr(\ty{\Gamma})\sqcap\pr(\ty{A})
\end{array}
\qquad
\begin{array}{lcl}
  \pr(\ty{\tyends[\cs{o}]}) & = & \cs{o} \\
  \pr(\ty{\tyendr[\cs{o}]}) & = & \cs{o} \\
  \pr(\ty{\tyunit})         & = & \ptop \\
  \pr(\ty{\tyvoid})         & = & \ptop \\
  \pr(\ty{S})               & = & \pr(\ty{S}) \\
  \pr(\ty{\emptyenv})       & = & \ptop
\end{array}
\]

\paragraph*{Syntactic Sugar for Types}
\[
  \ty{\tylolli{T}{U}} \elabarrow \ty{\tylolli[\cs{\ptop},\cs{\pbot}]{T}{U}}
\]

\paragraph*{Static Term Syntax}
We use $\tm{x}$, $\tm{y}$, $\tm{z}$, and $\tm{w}$ to range over variable names. Occasionally, we use $\tm{a}$, $\tm{b}$, and $\tm{c}$ to range over \emph{free} channel endpoints.
\[
\begin{array}{lcl}
  \tm{L}, \tm{M}, \tm{N}
  & \coloneqq & \tm{x}
    \sep        \tm{K}
    \sep        \tm{\lambda x.M}
    \sep        \tm{M\;N} \\
  & \sep      & \tm{\unit}
    \sep        \tm{\letunit{M}{N}} \\
  & \sep      & \tm{\pair{M}{N}}
    \sep        \tm{\letpair{x}{y}{M}{N}} \\
  & \sep      & \tm{\inl{M}}
    \sep        \tm{\inr{M}}
    \sep        \tm{\casesum{L}{x}{M}{y}{N}} \\
  & \sep      & \tm{\absurd{M}} \\
  \tm{K}
  & \coloneqq & \tm{\link}
    \sep        \tm{\new}
    \sep        \tm{\spawn}
    \sep        \tm{\send}
    \sep        \tm{\recv}
    \sep        \tm{\wait}
    \sep        \tm{\close}
\end{array}
\]

\paragraph*{Syntactic Sugar for Terms}
\[
\begin{array}{lcl}
  \tm{\andthen{M}{N}}
  & \elabarrow & \tm{\letunit{M}{N}} \\
  \tm{\letbind{x}{M}{N}}
  & \elabarrow & \tm{(\lambda x.N)\;M} \\
  \tm{\lambda\unit.M}
  & \elabarrow & \tm{\lambda z.\letunit{z}{M}} \\
  \tm{\lambda\pair{x}{y}.M}
  & \elabarrow & \tm{\lambda z.\letpair{x}{y}{z}{M}} \\
  \tm{\fork}
  & \elabarrow & \tm{\lambda x.\letpair{y}{z}{\new}{\andthen{\spawn\;{(\lambda\unit.x\;y)}}{z}}}
\end{array}
\]

\paragraph*{Syntactic Sugar for Internal and External Choice}
\[
\begin{array}{lcl}
  \ty{\tyselect[\cs{o}]{S}{S'}}
  & \elabarrow & \ty{\tysend[\cs{o}]{(\tysum{\co{S}}{\co{S'}})}{\tyends[\cs{o+1}]}} \\
  \ty{\tyoffer[\cs{o}]{S}{S'}}
  & \elabarrow & \ty{\tyrecv[\cs{o}]{(\tysum{S}{S'})}{\tyendr[\cs{o+1}]}} \\
\end{array}
\qquad
\begin{array}{lcl}
  \ty{\tyselectemp[\cs{o}]}
  & \elabarrow & \ty{\tysend[\cs{o}]{\tyvoid}{\tyends[\cs{o+1}]}} \\
  \ty{\tyofferemp[\cs{o}]}
  & \elabarrow & \ty{\tyrecv[\cs{o}]{\tyvoid}{\tyendr[\cs{o+1}]}} \\
\end{array}
\]
\[
\begin{array}{lcl}
  \tm{\select{\ell}}
  & \elabarrow & \tm{\lambda x.\letpair{y}{z}{\new}{\andthen{\close\;(\send\;{\pair{\ell\;y}{x}})}{z}}} \\
  \multicolumn{3}{l}{\tm{\offer{L}{x}{M}{y}{N}}\elabarrow} \\
  \multicolumn{3}{l}{
  \qquad\tm{\letpair{z}{w}{\recv\;{L}}{\andthen{\wait\;{w}}{\casesum{z}{x}{M}{y}{N}}}}} \\
  \tm{\offeremp{L}}
  & \elabarrow & \tm{\letpair{z}{w}{\recv\;L}{\andthen{\wait\;{w}}{\absurd{z}}}}
\end{array}
\]

\paragraph*{Runtime Term Syntax}
\[
\begin{array}[t]{lcl}
  \tm{\conf{C}}, \tm{\conf{D}}, \tm{\conf{E}}
  & \coloneqq & \tm{\phi\;M}
    \sep        \tm{\ppar{\conf{C}}{\conf{D}}}
    \sep        \tm{\res{x}{y}{\conf{C}}}
  \\
  \tm{\phi}
  & \coloneqq & \tm{\main}
    \sep        \tm{\child}
  \\
  \tm{V}, \tm{W}
  & \coloneqq & \tm{x}
    \sep        \tm{K}
    \sep        \tm{\lambda x.M}
    \sep        \tm{\unit}
    \sep        \tm{\pair{M}{N}}
    \sep        \tm{\inl{M}}
    \sep        \tm{\inr{M}}
  \\
  \tm{R}
  & \coloneqq & \tm{K\;V}
  \\
  \tm{E}
  & \coloneqq & \tm{\hole} \\
  & \sep      & \tm{E\;M}
    \sep        \tm{V\;E} \\
  & \sep      & \tm{\letunit{E}{N}} \\
  & \sep      & \tm{\pair{E}{M}}
    \sep        \tm{\pair{V}{E}}
    \sep        \tm{\letpair{x}{y}{E}{M}} \\
  & \sep      & \tm{\inl{E}}
    \sep        \tm{\inr{E}}
    \sep        \tm{\casesum{E}{x}{M}{y}{N}} \\
  & \sep      & \tm{\absurd{E}} \\
  \\
  \tm{\conf{F}}
  & \coloneqq & \tm{\phi\;E}
  \\
  \tm{\conf{G}}
  & \coloneqq & \tm{\hole} \\
  & \sep      & \tm{\ppar{\conf{G}}{\conf{C}}}
    \sep        \tm{\res{x}{y}{\conf{G}}}
\end{array}
\]
\[
\begin{array}{ll}
  \tm{\main}  + \tm{\child} = \tm{\main}
  \\
  \tm{\child} + \tm{\main}  = \tm{\main}
\end{array}
\quad
\begin{array}{ll}
  \tm{\child} + \tm{\child} = \tm{\child}
  \\
  \tm{\main}  + \tm{\main} \; \text{undefined}
\end{array}
\]

\subsection{Typing}
See \cref{fig:pgv-typing}.
\input{fig/pgv-typing}

\subsection{Operational Semantics}
See \cref{fig:pgv-operational-semantics}.
\input{fig/pgv-operational-semantics}

\subsection{Metatheory}

\begin{restatablelemma}{lempgvvaluedone}
  \label{lem:pgv-value-done}
  If $\tseq[\cs{o}]{\ty{\Gamma}}{V}{T}$, then $\cs{o}=\cs{\pbot}$, and $\pr(\ty{\Gamma})=\pr(\ty{T})$.
\end{restatablelemma}
\begin{proof}
  By induction on the derivation of $\tseq[\cs{o}]{\ty{\Gamma}}{V}{T}$.
  (Details in \cref{prf:lem-pgv-value-done}.)
\end{proof}

\begin{restatablelemma}{lempgvsubstitution}[Substitution]
  \label{lem:pgv-substitution}
  \hfill\\%newline before theorem statement
  If $\tseq[\cs{p}]{\ty{\Gamma},\tmty{x}{U'}}{M}{T}$ and $\tseq[\cs{q}]{\ty{\Theta}}{V}{U'}$, then $\tseq[\cs{p}]{\ty{\Gamma},\ty{\Theta}}{\subst{M}{V}{x}}{T}$.
\end{restatablelemma}
\begin{proof}
  By induction on the derivation of $\tseq[\cs{p}]{\ty{\Gamma},\tmty{x}{U'}}{M}{T}$. Whenever the contexts in the premises and conclusion differ, we use \cref{lem:pgv-value-done} to prove that the priorities are preserved.
  (Details in \cref{prf:lem-pgv-substitution}.)
\end{proof}

\begin{restatablelemma}{lempgvsubjectreductionterms}[Subject Reduction, $\tred$]
  \label{lem:pgv-subject-reduction-terms}
  \hfill\\%newline before theorem statement
  If $\tseq[\cs{o}]{\ty{\Gamma}}{M}{T}$ and $\tm{M}\tred\tm{M'}$,
  then $\tseq[\cs{o}]{\ty{\Gamma}}{M'}{T}$.
\end{restatablelemma}
\begin{proof}
  By induction on the derivation of $\tm{M}\tred\tm{M'}$.
  (Details in \cref{prf:lem-pgv-subject-reduction-terms}.)
\end{proof}

\begin{restatablelemma}{lempgvsubjectcongruence}[Subject Congruence, $\equiv$]
  \label{lem:pgv-subject-congruence}
  \hfill\\%newline before theorem statement
  If $\cseq[\phi]{\ty{\Gamma}}{\conf{C}}$ and $\tm{\conf{C}}\equiv\tm{\conf{C'}}$,
  then $\cseq[\phi]{\ty{\Gamma}}{\conf{C'}}$.
\end{restatablelemma}
\begin{proof}
  By induction on the derivation of $\tm{\conf{C}}\equiv\tm{\conf{C'}}$.
  (Details in \cref{prf:lem-pgv-subject-congruence}.)
\end{proof}

\begin{restatabletheorem}{thmpgvsubjectreductionconfs}[Subject Reduction, $\cred$]
  \label{thm:pgv-subject-reduction-confs}
  \hfill\\%newline before theorem statement
  If $\cseq[\phi]{\ty{\Gamma}}{\conf{C}}$ and $\tm{\conf{C}}\cred\tm{\conf{C'}}$,
  then $\cseq[\phi]{\ty{\Gamma}}{\conf{C'}}$.
\end{restatabletheorem}
\begin{proof}
  By induction on the derivation of $\tm{\conf{C}}\cred\tm{\conf{C'}}$.
  (Details in \cref{prf:thm-pgv-subject-reduction-confs}.)
\end{proof}

\begin{restatablelemma}{lempgvopenprogressterms}[Open Progress, $\tred$]
  \label{lem:pgv-open-progress-terms}
  If $\tseq[\cs{o}]{\ty{\Gamma}}{M}{T}$, then either:
  \begin{description}[labelwidth=8ex]
  \item[Done]
    $\tm{M}$ is a value;
  \item[Step]
    There exists some $\tm{N}$ such that $\tm{M}\tred\tm{N}$; or
  \item[Blocked]
    There exists some $\tm{E}$ and $\tm{R}$ such that $\tm{M}=\tm{\plug{E}{R}}$.
  \end{description}
\end{restatablelemma}
\begin{proof}
  By induction on the derivation of $\tseq[\cs{o}]{\ty{\Gamma}}{M}{T}$.
\end{proof}

\begin{definition}[Canonical Forms]
  \label{def:pgv-canonical-forms}
  A~configuration $\tm{\conf{C}}$ is in canonical form if it is of the form
  \(
    \tm{\res{x_1}{x'_1}{\dots\res{x_n}{x'_n}{(\child\;M_1\parallel\dots\parallel\child\;M_m\parallel\main\;N)}}}
  \)
  and no $\tm{M_i}$ is a value.
\end{definition}

\begin{restatablelemma}{lempgvcanonicalforms}
  \label{lem:pgv-canonical-forms}
  If $\cseq[\main]{\ty{\Gamma}}{\conf{C}}$, there exists some $\tm{\conf{D}}$ such that $\tm{\conf{C}}\equiv\tm{\conf{D}}$ and $\tm{\conf{D}}$ is in canonical form.
\end{restatablelemma}
\begin{proof}
  We move all $\nu$-binders to the top using \LabTirName{SC-ResExt}, move the main thread to the right using \LabTirName{SC-ParComm} and \LabTirName{SC-ParAssoc}, and if any thread is of the form $\tm{\child\;\unit}$, we discard it using \LabTirName{SC-ParNil}.
\end{proof}

\begin{definition}[Ready Terms]
  A~term $\tm{M}$ is ready on a variable $\tm{x}$, written $\ready\pair{\tm{M},\tm{x}}$, if $\tm{M}$ is of the form $\tm{\plug{E}{R}}$, where $\tm{E}$ is an evaluation context and $\tm{R}$ is $\tm{\send\;\pair{V}{x}}$, $\tm{\recv\;x}$, $\tm{\close\;x}$, or $\tm{\wait\;x}$.
\end{definition}

%%% <VERY UNDER CONSTRUCTION>

\begin{definition}
  A~term $\tm{M}$ is in a configuration $\tm{\conf{C}}$, written $\tm{M}\in\tm{\conf{C}}$, if there exists a configuration context $\tm{\conf{G}}$ such that $\tm{\conf{C}}=\tm{\plug{\conf{G}}{M}}$.
\end{definition}

\begin{definition}[Blocked Terms]
  A~term $\tm{M}\in\tm{\conf{C}}$ is blocked on a variable $\tm{x}$, written $\blocked_{\tm{\conf{C}}}\pair{\tm{M},\tm{x}}$, if $\ready\pair{\tm{M}}{\tm{x}}$, and no other term is ready on the dual of $\tm{x}$, \ie there exist no $\tm{\conf{G}}$, $\tm{\conf{D}}$, and $\tm{N}$ such that $\tm{C}=\tm{\plug{\conf{G}}{\res{x}{x'}{\conf{D}}}}$, $\tm{M},\tm{N}\in\tm{\conf{D}}$, and $\ready\pair{\tm{N}}{\tm{x'}}$. We omit the subscript $\tm{\conf{C}}$ if the configuration is clear from context.
\end{definition}

\begin{restatabletheorem}{thmpgvopenprogressconfs}[Open Progress, $\cred$]
  \label{thm:pgv-open-progress-confs}
  Suppose $\cseq[\main]{\ty{\Gamma}}{\conf{C}}$, where $\tm{\conf{C}}$ is in canonical form.
  Let $\tm{\conf{C}}=\tm{\res{x_1}{x'_1}{\dots\res{x_n}{x'_n}{(\child\;M_1\parallel\dots\parallel\child\;M_m\parallel\main\;N)}}}$.
  Either:
  \begin{description}[labelwidth=8ex]
  \item[Done]
    $\tm{N}$ is a value, and each $\tm{M_i}$ is either blocked, or a link on two free endpoints, \ie either $\blocked\pair{\tm{M_i}}{\tm{z}}$ for some $\tm{z}\in\{\tm{x_1},\tm{x'_1},\dots,\tm{x_n},\tm{x'_n}\}\cup\fv(\ty{\Gamma})$, or $\tm{M}=\tm{\plug{E}{\link\;\pair{a}{b}}}$ for some $\tm{a},\tm{b}\in\fv(\ty{\Gamma})$.
  \item[Step]
    There exists some $\tm{\conf{D}}$ such that $\tm{\conf{C}} \cred \tm{\conf{D}}$.
  \item[Blocked]
    $\tm{N}$ and each $\tm{M_i}$ is either blocked, or a link on two free endpoints, \ie either $\blocked\pair{\tm{M_i}}{\tm{z}}$ for some $\tm{z}\in\{\tm{x_1},\tm{x'_1},\dots,\tm{x_n},\tm{x'_n}\}\cup\fv(\ty{\Gamma})$, or $\tm{M}=\tm{\plug{E}{\link\;\pair{a}{b}}}$ for some $\tm{a},\tm{b}\in\fv(\ty{\Gamma})$.
  \end{description}
\end{restatabletheorem}
\begin{proof}
  We apply \cref{lem:pgv-canonical-forms} to $\tm{\conf{C}}$ to get an equivalent configuration in canonical form with flag $\phi$, $\tm{\res{x_1}{x'_1}{\dots\res{x_n}{x'_n}{(\child\;M_1\parallel\dots\parallel\child\;M_m\parallel\phi\;N)}}}$.
  We apply \cref{lem:pgv-open-progress-terms} to each term $\tm{M_i}$ and $\tm{N}$.
\end{proof}

%%% </VERY UNDER CONSTRUCTION>

\begin{corollary}[Closed Progress, $\cred$]
  \label{thm:pgv-closed-progress-confs}
  Suppose $\cseq[\main]{\emptyenv}{\conf{C}}$, where $\tm{\conf{C}}$ is in canonical form.
  Let $\tm{\conf{C}}=\tm{\res{x_1}{x'_1}{\dots\res{x_n}{x'_n}{(\child\;M_1\parallel\dots\parallel\child\;M_m\parallel\main\;N)}}}$.
  \begin{description}[labelwidth=8ex]
  \item[Done]
    $\tm{N}$ is a value, and for each $\tm{M_i}$, $\blocked\pair{\tm{M_i}}{\tm{z}}$ for some $\tm{z}\in\{\tm{x_1},\tm{x'_1},\dots,\tm{x_n},\tm{x'_n}\}$.
  \item[Step]
    There exists some $\tm{\conf{D}}$ such that $\tm{\conf{C}} \cred \tm{\conf{D}}$.
  \end{description}
\end{corollary}

\end{document}

%%% Local Variables:
%%% TeX-master: "priorities"
%%% End:
